<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">

    <link rel="icon" href="../assets/logo.png">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="../generalCss.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"></script>

    <script src="../Sigma/sigma.min.js"></script>
    <script src="../Sigma/plugins/sigma.plugins.dragNodes/sigma.plugins.dragNodes.js"></script>
    <script src="../Sigma/plugins/sigma.renderers.edgeLabels/settings.js"></script>
    <script src="../Sigma/plugins/sigma.renderers.edgeLabels/sigma.canvas.edges.labels.curve.js"></script>
    <script src="../Sigma/plugins/sigma.renderers.edgeLabels/sigma.canvas.edges.labels.curvedArrow.js"></script>
    <script src="../Sigma/plugins/sigma.renderers.edgeLabels/sigma.canvas.edges.labels.def.js"></script>

    <script src="../functions.js"></script>
    <script src="../city.js"></script>
    <script src="../tour-manager.js"></script>
    <script src="../tour.js"></script>
    <script src="../default-data.js"></script>
    <title>SA</title>

    <style>
        .leftContainer {
            position: absolute;
            width: 60%;
            height: calc(100vh - (60px));
            max-height: calc(100vh - (60px));
        }

        #sigma-container {
            width: 100%;
            max-height: inherit;
        }
    </style>


</head>
<body>
    <!-- Navbar -->
    <div id="nav-placeholder" style="height: 60px;"></div>

    <div class="content-container ">
        <br>
        <div class="panel-item" style=""><h3>Setting</h3></div>
        <div class="row" style="margin-top: 20px;">
            <div class="slideContainer panel-item col">
                <div class="sliderTitle disableAble">Number of Node:</div>
                <input type="range" min="5" max="25" value="15" class=" slider disableAble" id="nodeNum">
                <div id="nodeNumVal" class="sliderValue disableAble"></div>
            </div>
        </div>

        <div class="row" >
            <div class="slideContainer panel-item col">
                <div class="sliderTitle">Speed:</div>
                <input type="range" min="1" max="5" value="3" class=" slider" id="speed">
                <div id="speedVal" class="sliderValue"></div>
            </div>
        </div>

        <div class="row" >
            <div class="slideContainer panel-item col">
                <div class="sliderTitle disableAble">Initial Temperature:</div>
                <input type="range" min="10" max="5000" value="1000" class=" slider disableAble" id="initTemp">
                <div id="initTempVal" class="sliderValue disableAble"></div>
            </div>
        </div>

        <div class="row" >
            <div class="slideContainer panel-item col">
                <div class="sliderTitle disableAble">Cooling Rate:</div>
                <input type="range" min="0.001" max="1" value="0.003" class=" slider" id="coolingRate" step="0.001">
                <div id="coolingRateVal" class="sliderValue disableAble"></div>
            </div>
        </div>

        <div class="row panel-item">
            <div class="col">
                <div class="switchTitleOffset disableAble">Reheat</div>
                <label class="switch disableAble">
                    <input id="reheat" type="checkbox" onclick="toggleReheat()">
                    <span class="toggle round"></span>
                </label>
            </div>
        </div>

        <div class="row d-flex justify-content-between panel-item" style="padding-left: 15px;">
            <button id="runBtn" class="button" onclick="restart()">Run</button>
            <button id="randomBtn" class="button" onclick="randomiseCities()">Randomise Cities</button>
            <button id="resetBtn" class="button" onclick="resetDefault()">Reset Default</button>
        </div>

        <br><br>

        <div><h3>Result</h3></div>
        <div><h5><b>Initial Solution</b></h5></div>
        <div class="solutionHeader"><b>Tour:</b></div>
        <div id="initTour"></div>
        <div class="solutionHeader"><b>Total Distance:</b></div>
        <div id="initDistance"></div>
        <br>

        <div><h5><b>Current Solution</b></h5></div>
        <div class="solutionHeader"><b>Cities Swapped: </b></div>
        <div id="swapped"></div>
        <div class="solutionHeader"><b>Tour:</b></div>
        <div id="currentTour"></div>
        <div class="solutionHeader"><b>Total Distance:</b></div>
        <div id="currentDistance"></div>
        <br>

        <div><h5><b>Best Solution</b></h5></div>
        <div class="solutionHeader"><b>Tour:</b></div>
        <div id="bestTour"></div>
        <div class="solutionHeader"><b>Total Distance:</b></div>
        <div id="bestDistance" style="padding-bottom: 30px;"></div>
    </div>

    <div class="leftContainer">
            <span id="temperature" style="position: absolute; top:15px; left:28%">Temperature: </span>
            <span id="threshold" style="position: absolute; top:15px; left:55%">Max Threshold:</span>

        <div id='sigma-container'></div>
    </div>

    <div id="toast"></div>
</body>
</html>

<script>
    // HTML Related
    let algoSpeed = [1600, 1200, 800, 400, 1];
    let algoSpeedIndex = 2;
    let initTemp = 1000;
    let initCoolingRate =0.003;
    let enableReheat = false;

    let speedSlider = document.getElementById("speed");
    let speedVal = document.getElementById("speedVal");
    speedVal.innerHTML = speedSlider.value;

    speedSlider.oninput = function() {
        speedVal.innerHTML = this.value;
        algoSpeedIndex = this.value - 1;
    }

    let nodeSlider = document.getElementById("nodeNum");
    let nodeVal = document.getElementById("nodeNumVal");
    nodeVal.innerHTML = nodeSlider.value;

    nodeSlider.oninput = function() {
        nodeVal.innerHTML = this.value;
        randomiseCities();
    }

    let coolingRateSlider = document.getElementById("coolingRate");
    let coolingRateVal = document.getElementById("coolingRateVal");
    coolingRateVal.innerHTML = coolingRateSlider.value;

    coolingRateSlider.oninput = function() {
        coolingRateVal.innerHTML = this.value;
        initCoolingRate = parseFloat(this.value);
    }

    let initTempSlider = document.getElementById("initTemp");
    let initTempVal = document.getElementById("initTempVal");
    initTempVal.innerHTML = initTempSlider.value;

    initTempSlider.oninput = function() {
        initTempVal.innerHTML = this.value;
        initTemp = parseInt(this.value);
    }

    //Initialise sigma:
    let s = new sigma(
        {
            renderer: {
                container: document.getElementById('sigma-container'),
                type: 'canvas'
            },
            settings: {
                minEdgeSize: 1,
                maxEdgeSize: 3,
                minNodeSize: 1,
                maxNodeSize: 10,
                enableCamera: false,
                defaultEdgeLabelSize: 15,
                sideMargin: 30,
            }
        }
    );

    var graph = {
        nodes: [],
        edges: []
    };

    let dragListener = sigma.plugins.dragNodes(s, s.renderers[0]);
    dragListener.bind('dragend', function(event) {
        allowDrag(event);
    });

    // SA Program
    let simulatedTM = new TourManager();
    simulatedTM.clone(TM);

    let currentSolution = new Tour(simulatedTM.getTour());
    currentSolution.generateIndividual();
    let bestSolution = new Tour();
    bestSolution.clone(currentSolution);

    convertCityToNodes(simulatedTM, graph);
    updateSigma(s, graph);

    // Section for functions
    function convertCityToNodes_SA(tour, graph, pos1, pos2)
    {
        clearArray(graph.nodes);
        let nodeSize = 10;
        let nodeColor = "black";
        for(let i=0;i<tour.size();i++)
        {
            if(i==0)
                nodeColor = "red";
            else if (i==pos1 || i==pos2)
                nodeColor = "blue";
            else
                nodeColor = "orange";

            graph.nodes.push(
                {
                    id: tour.getCity(i).name,
                    label: tour.getCity(i).name,
                    x: tour.getCity(i).x,
                    y: tour.getCity(i).y,
                    size: nodeSize,
                    color: nodeColor,
                }
            )
        }
    }

    async function SA_TSP()
    {
        disableAll();

        // Set initial temp and cooling rate, etc
        let temp = initTemp;
        let coolingRate = initCoolingRate;
        let initialSolution = new Tour();
        let newSolution = new Tour();
        let tourPos1, tourPos2, currentEnergy, neighbourEnergy;
        let avgDistance = 0;
        let count = 0;
        let reheatCtr = 0;
        let threshold = 0.45;
        let thresholdDistance = 0;

        for(let i=0;i<10;i++)
        {
            avgDistance += currentSolution.getDistance();
            currentSolution.generateIndividual();
        }
        avgDistance = avgDistance / 10;
        thresholdDistance = avgDistance * threshold;

        initialSolution.clone(currentSolution);
        bestSolution.clone(initialSolution); // Set best as initial

        console.log("Initial solution distance: " + initialSolution.getDistance());
        console.log("cooling rate: " + coolingRate);
        console.log("Initial solution distance: " + currentSolution.getDistance());
        console.log("Tour: " + currentSolution.printTour());

        $("#initTour").text(initialSolution.printTour());
        $("#initDistance").text(initialSolution.getDistance().toFixed(2));
        $("#bestTour").text(bestSolution.printTour());
        $("#bestDistance").text(bestSolution.getDistance().toFixed(2));

        if(enableReheat)
            $("#threshold").text("Max Threshold: " + thresholdDistance.toFixed(2));

        // Loop until system has cooled
        while (temp > 1) {
            // Create new neighbour tour
            newSolution.clone(currentSolution);
            // newSolution = new Tour(currentSolution.getTour());

            // Get a random positions in the tour
            tourPos1 = Math.floor(newSolution.size() * Math.random());
            tourPos2 = Math.floor(newSolution.size() * Math.random());

            // Skip start node
            if(tourPos1 == 0)
                tourPos1++;
            if(tourPos2 == 0)
                tourPos2++;

            // ensure no index are different
            if(tourPos1 == tourPos2)
            {
                if(tourPos1 == simulatedTM.size()-1)
                {
                    tourPos1--;
                }
                else
                {
                    tourPos1++;
                }
            }

            let swap1 = newSolution.getCity(tourPos1).getName();
            let swap2 = newSolution.getCity(tourPos2).getName();
            // Swap them
            newSolution.swapCities(tourPos1, tourPos2);

            // Print new solution
            convertCityToNodes_SA(newSolution, graph, tourPos1, tourPos2);
            convertTourToEdges(newSolution, graph);
            updateSigma(s, graph);
            $("#temperature").text("Temperature: " + temp.toFixed(2) + "℃");
            $("#currentTour").text(newSolution.printTour());
            $("#currentDistance").text(newSolution.getDistance().toFixed(2));
            $("#swapped").text(swap1 + " & " + swap2);

            // Get energy of solutions
            currentEnergy = currentSolution.getDistance();
            neighbourEnergy = newSolution.getDistance();

            // Decide if we should accept the neighbour
            if (acceptanceProbability(currentEnergy, neighbourEnergy, temp) > Math.random()) {
                currentSolution = new Tour(newSolution.getTour());
            }

            // Keep track of the best solution found
            if (currentSolution.getDistance() < bestSolution.getDistance()) {
                bestSolution = new Tour(currentSolution.getTour());
                $("#bestTour").text(bestSolution.printTour());
                $("#bestDistance").text(bestSolution.getDistance().toFixed(2));
            }


            // Reheat
            // let enableReheat = false;
            if(temp < 1.5 && bestSolution.getDistance() > thresholdDistance && enableReheat==true) {
                temp = initTemp/4;

                reheatCtr++;

                if(reheatCtr==1)
                {
                    reheatCtr = 0;
                    threshold += 0.05;
                    thresholdDistance = avgDistance * threshold;
                    console.log("thresholdDistance:" + thresholdDistance);
                    $("#threshold").text("Max Threhold: " + thresholdDistance.toFixed(2));
                    toast("Reheated");
                }
            }

            await sleep(algoSpeed[algoSpeedIndex]);

            // Cool system
            temp *= 1 - coolingRate;
            count++;
        }

        console.log("count: " + count);

        convertCityToNodes(simulatedTM, graph);
        convertTourToEdges(bestSolution, graph);
        updateSigma(s, graph);
        $("#temperature").text("Temperature: " + temp.toFixed(2) + "℃");
        $("#bestTour").text(bestSolution.printTour());
        $("#bestDistance").text(bestSolution.getDistance().toFixed(2));
        console.log("Final solution distance: " + bestSolution.getDistance());
        console.log("Tour: " + bestSolution.printTour());

        enableAll();
    }

    function resetInfo() {
        $("#temperature").text("Temperature: ");
        $("#threshold").text("Max Threshold: ");
        $("#initTour").text("");
        $("#initDistance").text("");
        $("#currentTour").text("");
        $("#currentDistance").text("");
        $("#bestTour").text("");
        $("#bestDistance").text("");
        $("#swapped").text("");
    }

    function restart(){
        currentSolution.generateIndividual();
        bestSolution = new Tour(currentSolution);
        console.log(currentSolution.getDistance());
        console.log("outside: " + bestSolution.getDistance());
        resetInfo();
        SA_TSP();
    }

    function randomiseCities()
    {

        let num = $("#nodeNum").val();
        num = parseInt(num);
        simulatedTM.clear();

        let alp = 65;

        for(let i =65; i < (alp + num);i++)
        {
            simulatedTM.addCity(new City(String.fromCharCode(i)));
        }
        tour = new Tour(simulatedTM.getTour());

        convertCityToNodes(simulatedTM, graph);
        clearArray(graph.edges);
        updateSigma(s,graph);

        currentSolution = new Tour(simulatedTM.getTour());
        currentSolution.generateIndividual();
        bestSolution = new Tour(currentSolution);

        resetInfo();
    }

    function resetDefault() {
        simulatedTM.clear();
        simulatedTM.clone(TM);
        tour = new Tour(simulatedTM.getTour());
        convertCityToNodes(simulatedTM, graph);
        clearArray(graph.edges);
        updateSigma(s,graph);
        currentSolution = new Tour(simulatedTM.getTour());
        currentSolution.generateIndividual();
        bestSolution = new Tour(currentSolution);
        resetInfo();
    }

    function toggleReheat()
    {
        let toggleReheat = document.getElementById("reheat").checked;
        if(toggleReheat) {
            enableReheat = true;
        }
        else
        {
            enableReheat = false;
        }
    }

    function disableAll()
    {
        $("#runBtn").attr("disabled", true);
        $("#randomBtn").attr("disabled", true);
        $("#resetBtn").attr("disabled", true);
        $("#reheat").attr("disabled", true);
        $(".toggle").css("cursor", "not-allowed");
        $(".slider").attr("disabled", true);

        $('.disableAble').each(function() {
            this.className = this.className.replace(" disableAble", " disabled");
        });

        $('.slider').each(function() {
            this.className = this.className.replace(" slider", " slider2");
        });

        $("#speed").attr("disabled", false);
        document.getElementById("speed").className = "slider";

        sigma.plugins.killDragNodes(s);
    }

    function enableAll()
    {
        $("#runBtn").attr("disabled", false);
        $("#randomBtn").attr("disabled", false);
        $("#resetBtn").attr("disabled", false);
        $("#reheat").attr("disabled", false);
        $(".toggle").css("cursor", "pointer");
        $(".slider2").attr("disabled", false);

        $('.disabled').each(function() {
            this.className = this.className.replace(" disabled", " disableAble");
        });

        $('.slider2').each(function() {
            this.className = this.className.replace(" slider2", " slider");
        });

        dragListener = sigma.plugins.dragNodes(s, s.renderers[0]);
        dragListener.bind('dragend', function(event) {
            allowDrag(event);
        });
    }

    function allowDrag(event)
    {
        // replace city with new coordinates
        let node = event.data.node;
        let cityIndex = simulatedTM.findIndexByName(node.label);
        let newCity = new City(node.label, node.x, node.y);
        simulatedTM.destinationCities.splice(cityIndex,1, newCity);
        currentSolution = new Tour(simulatedTM.getTour());

        convertCityToNodes(simulatedTM, graph);
        clearArray(graph.edges);
        updateSigma(s,graph);
    }

</script>