<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Simulated Annealing Lesson</title>

    <link rel="icon" href="assets/logo.png">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="generalCss.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.0/css/all.min.css">

    <script src="Sigma/sigma.min.js"></script>
    <script src="Sigma/plugins/sigma.plugins.dragNodes/sigma.plugins.dragNodes.js"></script>
    <script src="Sigma/plugins/sigma.renderers.edgeLabels/settings.js"></script>
    <script src="Sigma/plugins/sigma.renderers.edgeLabels/sigma.canvas.edges.labels.curve.js"></script>
    <script src="Sigma/plugins/sigma.renderers.edgeLabels/sigma.canvas.edges.labels.curvedArrow.js"></script>
    <script src="Sigma/plugins/sigma.renderers.edgeLabels/sigma.canvas.edges.labels.def.js"></script>

    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <script src="js/functions.js"></script>
    <script src="js/tour.js"></script>
    <script src="js/default-data.js"></script>
    <style>
        .article {
            text-align: justify;
        }

        .section {
            margin-bottom: 80px;
        }

        #sigma-container{
            height: 250px;
            width: 33.33%;
            background: #E6E6E6;
        }

        #sigma-container2{
            height: 250px;
            width: 33.33%;
            background-color: #D6D6D6;
        }

        #sigma-container3{
            height: 250px;
            width: 33.33%;
            background-color: #c6c6c6;
        }

        #leftInfo {
            width: 33.33%;
            background: #E6E6E6;
            padding: 12px 12px 0;
        }

        #midInfo {
            width: 33.33%;
            background: #D6D6D6;
            padding: 12px 12px 0;
        }

        #rightInfo {
            width: 33.33%;
            background: #c6c6c6;
            padding: 12px 12px 0;
        }

        .pseudocode {
            background: #E0E0E0;
            width: 66.66%;
            height: 250px;
            overflow: auto;
        }

        .info {
            background: #E0E0E0;
            width: 33.33%;
            height: inherit;
            padding: 20px;
        }
    </style>
</head>
<body>
    <nav class="nav">
        <div id="nav-placeholder" ></div>
        <div id="currentAlgo" class="nav-item" style="float: right; padding-right: 50px;">
            Simulated Annealing
        </div>
    </nav>

    <div class="lesson-content-container">
        <div class="lesson-container">
            <h2>Simulated Annealing</h2>

            <div class="section">
                <h3>Overview</h3>
                <p class="article">
                    Simulated annealing is inspired by the annealing process in the metallurgy to obtain a “good shape” of
                    metal. The annealing process involves heating the metal to a high temperature and cools it down slowly.
                    If the metal is cooled very quickly, then the structure of metal will be disordered. On the other hand,
                    cooling the metal slowly allows the structure of a metal to become more ordered and stable.
                </p>
                <p class="article">
                    The general implementation of simulated annealing is fundamentally same as
                    <a href="HC-lesson.html" class="reference">hill climbing</a>,
                    where new solution is generated by swapping cities in the previous solution. However, simulated annealing
                    allows worse solution to replace the current solution in order to escape from the local minimum. Meanwhile,
                    the best solution is saved in case accepting worse solution does not lead to a better solution.
                </p>
                <p class="article">
                    In simulated annealing, there is a temperature variable that is used to simulated the heating process. The
                    temperature is also responsible for calculating the probability to accept a worse solution. As the temperature
                    decreases, the probability of accepting a worse also decreases. Hence, simulated annealing is able to escape
                    local minimum in the early execution and gradually focus on a specific search space. In other words, simulated
                    annealing behaves like hill climbing when the temperature is cooled down.
                </p>
            </div>

            <div class="section">
                <h3>Acceptance Function</h3>
                <p class="article">
                    Simulated annealing always replaces the current solution with the new solution if the new solution is better.
                    However, simulated annealing also can accept a worse solution based on the probability that can be calculated
                    with the following formula:
                    \[ probability = exp ({ - \Delta Distance \over temperature}) \]
                    It is generally best configuration for the algorithm is to have a high temperature and a low cooling rate.
                </p>

                <div class="d-flex" style="margin-top: 25px;">
                    <div style="width: 50%; padding: 25px; background: #E1E1E1;">
                        <h5>Worse Solution Case</h5>
                        <div>Current Solution Distance: 100</div>
                        <div>New Solution Distance: 150</div>
                        <br>
                        <div id="demoTemp">Temperature: 100℃</div>
                        <div id="demoProb">Acceptance Probability: 0.61</div>
                    </div>
                    <div style="width: 50%; padding: 25px; background: #D6D6D6;">
                        <h5>Better Solution Case</h5>
                        <div>Current Solution Distance: 150</div>
                        <div>New Solution Distance: 100</div>
                        <br>
                        <div id="demoTemp2">Temperature: 100℃</div>
                        <div>Acceptance Probability: 1.00</div>
                    </div>
                </div>
            </div>

            <div class="section">
                <h3>Pros and Cons</h3>
                <div class="d-flex">
                    <div class="pros">
                        <h5>Pros</h5>
                        <div>- Easy to implement</div>
                        <div>- Can escape local minimum</div>
                    </div>
                    <div class="cons">
                        <h5>Cons</h5>
                        <div>- Dependant on initial solution</div>
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="d-flex align-items-center" style="margin-bottom: 10px;">
                    <h3 style="margin-right: 15px">Concept Visualiser</h3>
                    <div id="startBtn" class="circle icon" onclick="start()">
                        <i class="fas fa-play"></i>
                    </div>
                </div>

                <div style="display: flex;">
                    <div id="leftInfo">
                        <div><b>Current solution</b></div>
                        <div id="d1">Distance: </div>
                    </div>
                    <div id="midInfo">
                        <div><b>New solution</b></div>
                        <div id="d2">Distance: </div>
                    </div>
                    <div id="rightInfo">
                        <div><b>Best solution</b></div>
                        <div id="d3">Distance: </div>
                    </div>
                </div>
                <div style="display: flex;">
                    <div id="sigma-container"></div>
                    <div id="sigma-container2"></div>
                    <div id="sigma-container3"></div>
                </div>
                <div class="d-flex">
                    <div class="info">
                        <h6 style="font-size: 1.5em">Information</h6>
                        <div>Temperature: <span id="pseudoTemp"></span></div>
                        <div>Acceptance Probability: <span id="pseudoProb"></span></div>
                        <div>Random Number: <span id="pseudoRand"></span></div>
                    </div>
                    <div class="pseudocode" id="pseudocode">
                        <h6 style="font-size: 1.5em">Steps</h6>
                        <div id="s1" class="d-flex">
                            <div class="num">1. </div>
                            <div>Generate a random initial solution, <i>i</i>.
                                Set <i>i</i> as current solution, <i>u</i>.
                                Set <i>u</i> as best solution, <i>s</i>.</div>
                        </div>
                        <div id="s2" class="d-flex">
                            <div class="num">2. </div>
                            <div><b>Repeat</b></div>
                        </div>
                        <div id="s3" class="d-flex">
                            <div class="num">3. </div>
                            <div class="tab">Generate new solution <i>k</i> by swapping 2 cities
                                in <i>u</i></div>
                        </div>
                        <div id="s4" class="d-flex">
                            <div class="num">4. </div>
                            <div class="tab"><b>If</b> <i>k</i> is shorter than <i>u</i>,
                                replace <i>u</i> with <i>k</i></div>
                        </div>
                        <div id="s5" class="d-flex">
                            <div class="num">5. </div>
                            <div class="tab"><b>Else</b></div>
                        </div>
                        <div id="s6" class="d-flex">
                            <div class="num">6. </div>
                            <div class="tab2">Generate a random number, <i>r</i>
                            and calculate acceptance probability, <i>p</i></div>
                        </div>
                        <div id="s7" class="d-flex">
                            <div class="num">7. </div>
                            <div class="tab2"><b>If</b> <i>r</i> is smaller than <i>p</i>,
                                replace <i>u</i> with <i>k</i></div>
                        </div>
                        <div id="s8" class="d-flex">
                            <div class="num">8. </div>
                            <div class="tab"><b>If</b> <i>u</i> shorter than <i>s</i>
                                replace <i>s</i> with <i>u</i></div>
                        </div>
                        <div id="s9" class="d-flex">
                            <div class="num">9. </div>
                            <div class="tab">Decrease temperature</div>
                        </div>
                        <div id="s10" class="d-flex">
                            <div class="num">10.</div>
                            <div><b>Until</b> the number of iterations executed</div>
                        </div>
                    </div>

                </div>
            </div>

            <div class="button-container">
                <a href="HC-lesson.html"><button class="button lesson-button">Previous</button></a>
                <a href="SA-program.html"><button class="button lesson-button purple">SA Program</button></a>
                <a href="SAR-lesson.html"><button class="button lesson-button">Next</button></a>
            </div>`
        </div>

    </div>
</body>
</html>
<script>
    // sigma  node
    let s = new sigma(
        {
            renderer: {
                container: document.getElementById('sigma-container'),
                type: 'canvas'
            },
            settings: {
                minEdgeSize: 1,
                maxEdgeSize: 3,
                minNodeSize: 1,
                maxNodeSize: 10,
                enableCamera: false,
                defaultEdgeLabelSize: 15,
                defaultNodeColor: 'black',
                sideMargin: 5,
            }
        }
    );

    let s2 = new sigma(
        {
            renderer: {
                container: document.getElementById('sigma-container2'),
                type: 'canvas'
            },
            settings: {
                minEdgeSize: 1,
                maxEdgeSize: 3,
                minNodeSize: 1,
                maxNodeSize: 10,
                enableCamera: false,
                defaultEdgeLabelSize: 15,
                defaultNodeColor: 'black',
                sideMargin: 5,
            }
        }
    );

    let s3 = new sigma(
        {
            renderer: {
                container: document.getElementById('sigma-container3'),
                type: 'canvas'
            },
            settings: {
                minEdgeSize: 1,
                maxEdgeSize: 3,
                minNodeSize: 1,
                maxNodeSize: 10,
                enableCamera: false,
                defaultEdgeLabelSize: 15,
                defaultNodeColor: 'black',
                sideMargin: 5,
            }
        }
    );

    let graph = {
        nodes: [],
        edges: []
    }

    // Program
    city1 = new City("c1", 40, 20);
    city2 = new City("c2", 55, 36);
    city3 = new City("c3", 38, 38);
    city4 = new City("c4", 26, 26);
    city5 = new City("c5", 26, 49);

    graphTM = new TourManager();
    graphTM.addCity(city1);
    graphTM.addCity(city2);
    graphTM.addCity(city3);
    graphTM.addCity(city4);
    graphTM.addCity(city5);
    tour = new Tour(graphTM.destinationCities);

    let currentSolution = new Tour(graphTM.destinationCities);
    let newSolution = new Tour(graphTM.destinationCities);
    let bestSolution = new Tour(graphTM.destinationCities);
    let stepIndex = 1;
    let step = "s1";
    let counter = 0;
    let pseudoTemp = 100;
    let pseudoProb = 0.61;
    let random = 0;
    let probability = 0;
    let demoTemp = 100;

    updateSigma(s, graph);
    setInterval(animateProb, 1500)
    DivElmnt = document.getElementById('pseudocode');
    scrollId = '#pseudocode'
    scrollHeight = $(scrollId).height() / 10;

    // Functions
    function step1()
    {
        currentSolution.generateIndividual();
        bestSolution.clone(currentSolution);
        convertCityToNodes_black(graphTM, graph);
        convertTourToEdges(currentSolution, graph);
        updateSigma(s, graph);
        updateSigma(s3, graph);
        step = "s" + stepIndex.toString();
        document.getElementById(step).className += " highlight";
        $("#d1").text("Distance: " + currentSolution.getDistance().toFixed(2));
        $("#d3").text("Distance: " + currentSolution.getDistance().toFixed(2));
        $("#pseudoTemp").text(pseudoTemp + "℃");
        // $("#pseudoProb").text("Acceptance Probability: " + 0.00);

        stepIndex = 2;
        // DivElmnt.scrollTop = 5;
        scroll(scrollId, 0);
    }

    function step2(){
        counter++;
        updateStep();
        // DivElmnt.scrollTop = 20;
        scroll(scrollId, (0 * scrollHeight));
    }

    function step3() {
        updateStep();

        newSolution.clone(currentSolution);


        let tourPos1 = -1;
        let tourPos2 = -1;

        tourPos1 = Math.floor(tour.size() * Math.random());
        tourPos2 = Math.floor(tour.size() * Math.random());

        // Skip start node
        if(tourPos1 == 0)
            tourPos1++;
        if(tourPos2 == 0)
            tourPos2++;

        // ensure no index are different
        if(tourPos1 == tourPos2)
        {
            if(tourPos1 == tour.size()-1)
            {
                tourPos1--;
            }
            else
            {
                tourPos1++;
            }
        }
        // Swap them
        newSolution.swapCities(tourPos1, tourPos2);
        convertSwapCityToNodes_black(newSolution, graph, tourPos1, tourPos2);
        convertTourToEdges(newSolution, graph);
        updateSigma(s2, graph);

        $("#d2").text("Distance: " + newSolution.getDistance().toFixed(2));

        // if(newSolution.getDistance() < currentSolution.getDistance())
        // {
        //     stepIndex = 4;
        //     currentSolution = new Tour(newSolution.getTour());
        // }
        // else
        //     stepIndex = 5;
        // DivElmnt.scrollTop = 30;

        scroll(scrollId, (2 * scrollHeight));
    }

    function step4(){
        updateStep();
        if(newSolution.getDistance() < currentSolution.getDistance()) {
            stepIndex = 8;
            currentSolution = new Tour(newSolution.getTour());
            convertCityToNodes_black(graphTM, graph);
            updateSigma(s, graph);
            $("#d1").text("Distance: " + currentSolution.getDistance().toFixed(2));
        }
        else
            stepIndex = 5;

        // DivElmnt.scrollTop = 40;
        scroll(scrollId, (2 * scrollHeight));
    }

    function step5() {
        updateStep();
        // stepIndex++;
        // DivElmnt.scrollTop = 50;
        scroll(scrollId, (4 * scrollHeight));
    }

    function step6() {
        updateStep();
        random = Math.random();
        $("#pseudoRand").text(random.toFixed(2));
        probability = acceptanceProbability(currentSolution.getDistance(), newSolution.getDistance(), demoTemp);
        $("#pseudoProb").text(probability.toFixed(2));
        // DivElmnt.scrollTop = 60;
        // scroll(scrollId, (5 * scrollHeight));
    }


    function step7() {
        updateStep();

        if (probability > random) {
            currentSolution = new Tour(newSolution.getTour());
            convertCityToNodes_black(graphTM, graph);
            updateSigma(s, graph);
            $("#d1").text("Distance: " + currentSolution.getDistance().toFixed(2));
        }

        // DivElmnt.scrollTop = 70;
        scroll(scrollId, (10 * scrollHeight));
    }

    function step8(){
        updateStep();
        if(currentSolution.getDistance() < bestSolution.getDistance())
        {
            bestSolution = new Tour(currentSolution.getTour());
            convertCityToNodes_black(graphTM, graph);
            updateSigma(s3, graph);
            $("#d3").text("Distance: " + currentSolution.getDistance().toFixed(2));
        }
        // DivElmnt.scrollTop = 80;
        scroll(scrollId, (10 * scrollHeight));
    }
    
    function step9() {
        updateStep();
        pseudoTemp -= 5;
        $("#pseudoTemp").text(pseudoTemp + "℃");
        stepIndex = 2;
        // DivElmnt.scrollTop = 90;
        scroll(scrollId, (10 * scrollHeight));
    }

    function step10() {
        updateStep();
        stepIndex++;
        // DivElmnt.scrollTop = 100;
        scroll(scrollId, (8 * scrollHeight));
    }


    function animateProb(){
        let probability = acceptanceProbability(100, 150, demoTemp);
        $("#demoTemp").text("Temperature: " + demoTemp + "℃");
        $("#demoTemp2").text("Temperature: " + demoTemp + "℃");
        $("#demoProb").text("Acceptance Probability: " + probability.toFixed(2));

        demoTemp -= 10;

        if(demoTemp==0)
            demoTemp = 100;
    }

    function start() {
        disableDemo();
        resetDemo();
        auto();
    }

    function disableDemo() {
        document.getElementById( "startBtn" ).setAttribute( "onClick", "javascript: nothing();" );
        document.getElementById("startBtn"). className += " disabled";
    }

    function enableDemo() {
        document.getElementById( "startBtn" ).setAttribute( "onClick", "javascript: start();" );
        document.getElementById("startBtn"). className =
            document.getElementById("startBtn"). className.replace(" disabled", "");
    }

    function resetDemo()
    {
        $("#d1").text("Distance: ");
        $("#d2").text("Distance: ");
        $("#d3").text("Distance: ");
        $("#pseudoTemp").text("");
        $("#pseudoProb").text("");
        $("#pseudoRand").text("");
        stepIndex = 1;
        counter = 1;
        s2.graph.clear();
        s2.refresh();
        convertCityToNodes_black(graphTM, graph);
        updateSigma(s, graph);
    }

    async function auto()
    {
        while(stepIndex <= 10)
        {
            if(counter>7)
            {
                stepIndex = 10;
                step10();
            }

            if(stepIndex==1)
                step1();
            else if(stepIndex==2)
                step2();
            else if(stepIndex==3)
                step3();
            else if(stepIndex==4)
                step4();
            else if(stepIndex==5)
                step5();
            else if(stepIndex==6)
                step6();
            else if(stepIndex==7)
                step7();
            else if(stepIndex==8)
                step8();
            else if(stepIndex==9)
                step9();
            await sleep(2000);
        }
        let x = document.getElementsByClassName("highlight");
        x[0].className = x[0].className.replace(" highlight", "");
        stepIndex = 1;
        enableDemo();
    }

</script>
