<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">

    <link rel="icon" href="logo.png">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="generalCss.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"></script>

    <script src="Sigma/sigma.min.js"></script>
    <script src="Sigma/plugins/sigma.plugins.dragNodes/sigma.plugins.dragNodes.js"></script>
    <script src="Sigma/plugins/sigma.renderers.edgeLabels/settings.js"></script>
    <script src="Sigma/plugins/sigma.renderers.edgeLabels/sigma.canvas.edges.labels.curve.js"></script>
    <script src="Sigma/plugins/sigma.renderers.edgeLabels/sigma.canvas.edges.labels.curvedArrow.js"></script>
    <script src="Sigma/plugins/sigma.renderers.edgeLabels/sigma.canvas.edges.labels.def.js"></script>

    <script src="functions.js"></script>
    <script src="city.js"></script>
    <script src="tour-manager.js"></script>
    <script src="tour.js"></script>
    <script src="default-data.js"></script>
    <title>SA</title>

    <style>
        .leftContainer {
            position: absolute;
            width: 60%;
            height: calc(100vh - (60px));
            max-height: calc(100vh - (60px));
        }

        #sigma-container {
            width: 100%;
            max-height: inherit;
        }

        .displayInfo {
            position: absolute;
            top:15px;
            width: 100%;
            margin: auto;
            display: flex;
            justify-content: space-around;
        }
        /*.content-container {*/
        /*    overflow: hidden;*/
        /*}*/

        /*.content-container:hover {*/
        /*    overflow: auto;*/
        /*}*/

    </style>


</head>
<body>
    <!-- Navbar -->
    <nav class="nav">
        <div id="nav-placeholder" ></div>
        <div id="currentAlgo" class="nav-item" style="float: right; padding-right: 50px;">
            Simulated Annealing
        </div>
    </nav>

    <div class="content-container ">
        <br>
        <div class="panel-item" style=""><h3>Setting</h3></div>
        <div class="row" style="margin-top: 20px;">
            <div class="slideContainer panel-item col">
                <div class="sliderTitle disableAble">Number of Cities:</div>
                <input type="range" min="5" max="100" value="15" class=" slider disableAble" id="nodeNum">
                <input type="number" id="nodeNumVal" class="sliderValue disableAble" value="15">
            </div>
        </div>

        <div class="row" >
            <div class="slideContainer panel-item col">
                <div class="sliderTitle">Speed:</div>
                <input type="range" min="1" max="5" value="3" class=" slider" id="speed">
                <input type="number" id="speedVal" class="sliderValue" value="3">
            </div>
        </div>

        <div class="row" >
            <div class="slideContainer panel-item col">
                <div class="sliderTitle disableAble">Initial Temperature:</div>
                <input type="range" min="100" max="5000" value="1000" class=" slider disableAble" id="initTemp">
                <input type="number"id="initTempVal" class="sliderValue disableAble" value="1000">
            </div>
        </div>

        <div class="row" >
            <div class="slideContainer panel-item col">
                <div class="sliderTitle disableAble">Cooling Rate:</div>
                <input type="range" min="0.001" max="1" value="0.003" class=" slider disableAble" id="coolingRate" step="0.001">
                <input type="number" id="coolingRateVal" class="sliderValue disableAble" value="0.003">
            </div>
        </div>

        <div class="row" >
            <div class="slideContainer panel-item col">
                <div class="sliderTitle disableAble" id="iterationID">Iterations:</div>
                <input type="range" min="100" max="10000" value="1000" class=" slider disableAble" id="initIteration" >
                <input type="number" id="iterationVal" class="sliderValue disableAble" value="1000">
            </div>
        </div>

        <div class="row panel-item">
            <div class="col">
                <div class="switchTitleOffset disableAble">Reheat</div>
                <label class="switch disableAble">
                    <input id="reheat" type="checkbox" onclick="toggleReheat()">
                    <span class="toggle round"></span>
                </label>
            </div>
        </div>

        <div class="row d-flex justify-content-between panel-item" style="padding-left: 15px;">
            <button id="runBtn" class="button" onclick="restart()">Run</button>
            <button id="randomBtn" class="button" onclick="randomiseCities()">Randomise Cities</button>
            <button id="resetBtn" class="button" onclick="resetDefault()">Reset Default</button>
        </div>

        <br><br>

        <div><h3>Result</h3></div>
        <div><h5><b>Initial Solution</b></h5></div>
        <div class="solutionHeader">
            <b>Total Distance:</b> <span id="initDistance"></span>
        </div>
        <div class="solutionHeader"><b>Tour:</b></div>
        <div id="initTour"></div>

        <br>

        <div><h5><b>Current Solution</b></h5></div>
        <div class="solutionHeader">
            <b>Cities Swapped: </b> <span id="swapped"></span>
        </div>
        <div class="solutionHeader">
            <b>Total Distance:</b> <span id="currentDistance"></span>
        </div>

        <div class="solutionHeader"><b>Tour:</b></div>
        <div id="currentTour"></div>


        <br>

        <div><h5><b>Best Solution</b></h5></div>
        <div class="solutionHeader" >
         <b>Total Distance:</b> <span id="bestDistance" ></span>
        </div>
        <div class="solutionHeader"><b>Tour:</b></div>
        <div id="bestTour" style="padding-bottom: 30px;"></div>

    </div>

    <div class="leftContainer">
        <div class="displayInfo">
            <span id="iteration" >Iteration: </span>
            <span id="temperature" >Temperature: </span>
            <span id="threshold" >Max Threshold:</span>
        </div>
        <div id='sigma-container'></div>
    </div>

    <div id="toast"></div>
</body>
</html>

<script>
    // HTML Related
    let algoSpeed = [1600, 1200, 800, 400, 1];
    let algoSpeedIndex = 2;
    let initTemp = 1000;
    let initCoolingRate =0.003;
    let enableReheat = false;
    let iterationNum = 999999;

    let speedSlider = document.getElementById("speed");
    let speedVal = document.getElementById("speedVal");

    speedSlider.oninput = function() {
        speedVal.value = this.value;
        algoSpeedIndex = this.value - 1;
    }

    $("#speedVal").focusout(function () {
        let temp = speedSlider.value;
        let value = $("#speedVal").val();
        value = parseInt(value);
        if(Number.isInteger(value)==false)
        {
            this.value = temp;
        }
        else
        {
            this.value = value;
            if (value < 1 )
                this.value = 1;
            else if (value > 5)
                this.value = 5;
            $("#speed").val(value);
            algoSpeedIndex = value - 1;
        }
    });

    let nodeSlider = document.getElementById("nodeNum");
    let nodeVal = document.getElementById("nodeNumVal");

    nodeSlider.oninput = function() {
        nodeVal.value = this.value;
        randomiseCities();
    }

    $("#nodeNumVal").focusout(function () {
        let temp = nodeSlider.value;
        let value = $("#nodeNumVal").val();
        value = parseInt(value);
        if(Number.isInteger(value)==false)
        {
            this.value = temp;
        }
        else
        {
            this.value = value;
            if (value < 5 )
                this.value = 5;
            else if (value > 100)
                this.value = 100;
            $("#nodeNum").val(this.value);
            randomiseCities();
        }
    });

    let coolingRateSlider = document.getElementById("coolingRate");
    let coolingRateVal = document.getElementById("coolingRateVal");

    coolingRateSlider.oninput = function() {
        coolingRateVal.value = this.value;
        initCoolingRate = parseFloat(this.value);
    }


    $("#coolingRateVal").focusout(function () {
        let temp = coolingRateSlider.value;
        let value = $("#coolingRateVal").val();
        value = parseFloat(value);

        if(Number.isFinite(value)==false)
        {
            this.value = temp;
        }
        else
        {
            value = parseFloat(value.toFixed(3));
            this.value = value;
            if (value < 0.001 )
                this.value = 0.001;
            else if (value > 1)
                this.value = 1;
            $("#coolingRate").val(value);
            initCoolingRate = parseFloat(this.value);
        }
    });

    let initTempSlider = document.getElementById("initTemp");
    let initTempVal = document.getElementById("initTempVal");

    initTempSlider.oninput = function() {
        initTempVal.value = this.value;
        initTemp = parseInt(this.value);
    }

    $("#initTempVal").focusout(function () {
        let temp = initTempSlider.value;
        let value = $("#initTempVal").val();
        value = parseInt(value);
        if(Number.isInteger(value)==false)
        {
            this.value = temp;
        }
        else
        {
            this.value = value;
            if (value < 100 )
                this.value = 100;
            else if (value > 5000)
                this.value = 5000;
            $("#initTemp").val(this.value);
            initTemp = this.value;
        }
    });

    let initIterationSlider = document.getElementById("initIteration");
    let iterationVal = document.getElementById("iterationVal");

    initIterationSlider.oninput = function() {
        iterationVal.value = this.value;
        iterationNum = parseInt(this.value);
    }

    $("#iterationVal").focusout(function () {
        let temp = initIterationSlider.value;
        let value = $("#iterationVal").val();
        value = parseInt(value);
        if(Number.isInteger(value)==false)
        {
            this.value = temp;
        }
        else
        {
            this.value = value;
            if (value < 100 )
                this.value = 100;
            else if (value > 10000)
                this.value = 10000;
            $("#initIteration").val(this.value);
            iterationNum = parseInt(this.value);
        }
    });

    //Initialise sigma:
    let s = new sigma(
        {
            renderer: {
                container: document.getElementById('sigma-container'),
                type: 'canvas'
            },
            settings: {
                minEdgeSize: 1,
                maxEdgeSize: 3,
                minNodeSize: 1,
                maxNodeSize: 10,
                enableCamera: false,
                defaultEdgeLabelSize: 15,
                sideMargin: 30,
            }
        }
    );

    var graph = {
        nodes: [],
        edges: []
    };

    let dragListener = sigma.plugins.dragNodes(s, s.renderers[0]);
    dragListener.bind('dragend', function(event) {
        allowDrag(event);
    });

    // SA Program
    let simulatedTM = new TourManager();
    simulatedTM.clone(TM);

    let currentSolution = new Tour(simulatedTM.getTour());
    currentSolution.generateIndividual();
    let bestSolution = new Tour();
    bestSolution.clone(currentSolution);

    convertCityToNodes(simulatedTM, graph);
    updateSigma(s, graph);

    // Section for functions
    function convertCityToNodes_SA(tour, graph, pos1, pos2)
    {
        clearArray(graph.nodes);
        let nodeSize = 10;
        let nodeColor = "black";
        for(let i=0;i<tour.size();i++)
        {
            if(i==0)
                nodeColor = "red";
            else if (i==pos1 || i==pos2)
                nodeColor = "blue";
            else
                nodeColor = "orange";

            graph.nodes.push(
                {
                    id: tour.getCity(i).name,
                    label: tour.getCity(i).name,
                    x: tour.getCity(i).x,
                    y: tour.getCity(i).y,
                    size: nodeSize,
                    color: nodeColor,
                }
            )
        }
    }

    async function SA_TSP()
    {
        disableAll();

        if(enableReheat)
            iterationNum = 99999;
        else
            iterationNum = initIterationSlider.value;


        // Set initial temp and cooling rate, etc
        let temp = initTemp;
        let coolingRate = initCoolingRate;
        let initialSolution = new Tour();
        let newSolution = new Tour();
        let tourPos1, tourPos2, currentEnergy, neighbourEnergy;
        let avgDistance = 0;
        let count = 1;
        let reheatCtr = 0;
        let threshold = 0.40;
        let thresholdDistance = 0;

        for(let i=0;i<10;i++)
        {
            avgDistance += currentSolution.getDistance();
            currentSolution.generateIndividual();
        }
        avgDistance = avgDistance / 10;
        thresholdDistance = avgDistance * threshold;

        initialSolution.clone(currentSolution);
        bestSolution.clone(initialSolution); // Set best as initial

        console.log("Initial solution distance: " + initialSolution.getDistance());
        console.log("cooling rate: " + coolingRate);
        console.log("Initial solution distance: " + currentSolution.getDistance());
        console.log("Tour: " + currentSolution.printTour());

        $("#initTour").text(initialSolution.printTour());
        $("#initDistance").text(initialSolution.getDistance().toFixed(2));
        $("#bestTour").text(bestSolution.printTour());
        $("#bestDistance").text(bestSolution.getDistance().toFixed(2));

        if(enableReheat)
            $("#threshold").text("Max Threshold: " + thresholdDistance.toFixed(2));

        // Loop until system has cooled
        while (temp >= 1 && count<=iterationNum) {

            if(enableReheat && bestSolution.getDistance()< thresholdDistance)
                break;

            // Create new neighbour tour
            newSolution.clone(currentSolution);
            // newSolution = new Tour(currentSolution.getTour());

            // Get a random positions in the tour
            tourPos1 = Math.floor(newSolution.size() * Math.random());
            tourPos2 = Math.floor(newSolution.size() * Math.random());

            // Skip start node
            if(tourPos1 == 0)
                tourPos1++;
            if(tourPos2 == 0)
                tourPos2++;

            // ensure no index are different
            if(tourPos1 == tourPos2)
            {
                if(tourPos1 == simulatedTM.size()-1)
                {
                    tourPos1--;
                }
                else
                {
                    tourPos1++;
                }
            }

            let swap1 = newSolution.getCity(tourPos1).getName();
            let swap2 = newSolution.getCity(tourPos2).getName();
            // Swap them
            newSolution.swapCities(tourPos1, tourPos2);

            // Print new solution
            convertCityToNodes_SA(newSolution, graph, tourPos1, tourPos2);
            convertTourToEdges(newSolution, graph);
            updateSigma(s, graph);
            $("#temperature").text("Temperature: " + temp.toFixed(2) + "℃");
            $("#iteration").text("Iteration: " + count);
            $("#currentTour").text(newSolution.printTour());
            $("#currentDistance").text(newSolution.getDistance().toFixed(2));
            $("#swapped").text(swap1 + " & " + swap2);

            // Get energy of solutions
            currentEnergy = currentSolution.getDistance();
            neighbourEnergy = newSolution.getDistance();

            // Decide if we should accept the neighbour
            if (acceptanceProbability(currentEnergy, neighbourEnergy, temp) > Math.random()) {
                currentSolution = new Tour(newSolution.getTour());
            }

            // Keep track of the best solution found
            if (currentSolution.getDistance() < bestSolution.getDistance()) {
                bestSolution = new Tour(currentSolution.getTour());
                $("#bestTour").text(bestSolution.printTour());
                $("#bestDistance").text(bestSolution.getDistance().toFixed(2));
            }


            // Reheat
            // let enableReheat = false;
            if(temp < 10 && bestSolution.getDistance() > thresholdDistance && enableReheat==true) {
                temp = initTemp/4;
                reheatCtr++;

                if(reheatCtr==1)
                {
                    reheatCtr = 0;
                    threshold += 0.05;
                    thresholdDistance = avgDistance * threshold;
                    console.log("thresholdDistance:" + thresholdDistance);
                    $("#threshold").text("Max Threhold: " + thresholdDistance.toFixed(2));
                    toast("Reheated");
                }
            }

            await sleep(algoSpeed[algoSpeedIndex]);

            // Cool system
            temp *= 1 - coolingRate;
            count++;

            if(temp<1)
            {
                temp = 1;
            }
        }

        console.log("count: " + count);

        convertCityToNodes(simulatedTM, graph);
        convertTourToEdges(bestSolution, graph);
        updateSigma(s, graph);
        $("#temperature").text("Temperature: " + temp.toFixed(2) + "℃");
        $("#bestTour").text(bestSolution.printTour());
        $("#bestDistance").text(bestSolution.getDistance().toFixed(2));
        console.log("Final solution distance: " + bestSolution.getDistance());
        console.log("Tour: " + bestSolution.printTour());

        enableAll();
    }

    function resetInfo() {
        $("#temperature").text("Temperature: ");
        $("#threshold").text("Max Threshold: ");
        $("#initTour").text("");
        $("#initDistance").text("");
        $("#currentTour").text("");
        $("#currentDistance").text("");
        $("#bestTour").text("");
        $("#bestDistance").text("");
        $("#swapped").text("");
    }

    function restart(){
        currentSolution.generateIndividual();
        bestSolution = new Tour(currentSolution);
        console.log(currentSolution.getDistance());
        console.log("outside: " + bestSolution.getDistance());
        resetInfo();
        SA_TSP();
    }

    function randomiseCities()
    {

        let num = $("#nodeNum").val();
        num = parseInt(num);
        simulatedTM.clear();

        // let alp = 65;
        //
        // for(let i =65; i < (alp + num);i++)
        // {
        //     simulatedTM.addCity(new City(String.fromCharCode(i)));
        // }

        for(let i=1;i<=num;i++)
        {
            simulatedTM.addCity(new City( "c" + i));
        }
        tour = new Tour(simulatedTM.getTour());

        convertCityToNodes(simulatedTM, graph);
        clearArray(graph.edges);
        updateSigma(s,graph);

        currentSolution = new Tour(simulatedTM.getTour());
        currentSolution.generateIndividual();
        bestSolution = new Tour(currentSolution);

        resetInfo();
    }

    function resetDefault() {
        simulatedTM.clear();
        simulatedTM.clone(TM);
        tour = new Tour(simulatedTM.getTour());
        convertCityToNodes(simulatedTM, graph);
        clearArray(graph.edges);
        updateSigma(s,graph);
        currentSolution = new Tour(simulatedTM.getTour());
        currentSolution.generateIndividual();
        bestSolution = new Tour(currentSolution);
        resetInfo();
    }

    function toggleReheat()
    {
        let toggleReheat = document.getElementById("reheat").checked;
        if(toggleReheat) {
            enableReheat = true;
            document.getElementById("iterationID").className += " disabled";
            document.getElementById("initIteration").className += " disabled";
            document.getElementById("iterationVal").className += " disabled";
            $("#initIteration").attr("disabled", true);
            document.getElementById("initIteration").className
                = document.getElementById("initIteration").className.replace(" slider", " slider2");
        }
        else
        {
            enableReheat = false;
            $('.disabled').each(function() {
                this.className = this.className.replace(" disabled", " disableAble");
            });
            $("#initIteration").attr("disabled", false);
            document.getElementById("initIteration").className
                = document.getElementById("initIteration").className.replace(" slider2", " slider");

        }
    }

    function disableAll()
    {
        $("#runBtn").attr("disabled", true);
        $("#randomBtn").attr("disabled", true);
        $("#resetBtn").attr("disabled", true);
        $("#reheat").attr("disabled", true);
        $(".toggle").css("cursor", "not-allowed");
        $(".slider").attr("disabled", true);

        $('.disableAble').each(function() {
            this.className = this.className.replace(" disableAble", " disabled");
        });

        $('.slider').each(function() {
            this.className = this.className.replace(" slider", " slider2");
        });

        $("#speed").attr("disabled", false);
        document.getElementById("speed").className = "slider";

        sigma.plugins.killDragNodes(s);
    }

    function enableAll()
    {
        $("#runBtn").attr("disabled", false);
        $("#randomBtn").attr("disabled", false);
        $("#resetBtn").attr("disabled", false);
        $("#reheat").attr("disabled", false);
        $(".toggle").css("cursor", "pointer");
        $(".slider2").attr("disabled", false);

        $('.disabled').each(function() {
            this.className = this.className.replace(" disabled", " disableAble");
        });

        $('.slider2').each(function() {
            this.className = this.className.replace(" slider2", " slider");
        });

        dragListener = sigma.plugins.dragNodes(s, s.renderers[0]);
        dragListener.bind('dragend', function(event) {
            allowDrag(event);
        });
    }

    function allowDrag(event)
    {
        // replace city with new coordinates
        let node = event.data.node;
        let cityIndex = simulatedTM.findIndexByName(node.label);
        let newCity = new City(node.label, node.x, node.y);
        simulatedTM.destinationCities.splice(cityIndex,1, newCity);
        currentSolution = new Tour(simulatedTM.getTour());

        convertCityToNodes(simulatedTM, graph);
        clearArray(graph.edges);
        updateSigma(s,graph);
    }

</script>