<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="generalCss.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.0/css/all.min.css">

    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0"></script>
    <script src="Sigma/sigma.min.js"></script>
    <script src="Sigma/plugins/sigma.plugins.dragNodes/sigma.plugins.dragNodes.js"></script>
    <script src="Sigma/plugins/sigma.renderers.edgeLabels/settings.js"></script>
    <script src="Sigma/plugins/sigma.renderers.edgeLabels/sigma.canvas.edges.labels.curve.js"></script>
    <script src="Sigma/plugins/sigma.renderers.edgeLabels/sigma.canvas.edges.labels.curvedArrow.js"></script>
    <script src="Sigma/plugins/sigma.renderers.edgeLabels/sigma.canvas.edges.labels.def.js"></script>

    <script src="functions.js"></script>
    <script src="city.js"></script>
    <script src="tour-manager.js"></script>
    <script src="tour.js"></script>
    <script src="population.js"></script>
    <script src="ga.js"></script>
    <script src="default-data.js"></script>
    <title>GA</title>
    <style>

        .setting-container {
            width: 40%;
            padding-right: 50px;
        }

        .result-container {
            position: absolute;
            left: 50%;
            padding-left: 50px;
        }

        .circle {
            color: hsla(0,0%,100%,.5);
            background-color: #2196F3;
            opacity: 0.8;
            cursor: pointer;
            padding: 0;
            margin: .5em;
            border-radius: 100%;
            width: 40px;
            height: 40px;
            transition: color .25s,background-color .5s;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1;
        }

        .circle:hover {
            opacity: 1;
        }

        .icon {
            position: absolute;
            right: 1px;
            top: -1px;
            z-index: 1;
            font-size: 1.3em;
            color:white
        }

        .leftContainer {
            position: absolute;
            width: 60%;
            height: calc(100vh - (60px));
            max-height: calc(100vh - (60px));
        }

        .top-container {
            /*position: absolute;*/
            width: 100%;
            height: calc(50%);
            heigt: calc( (100vh - (60px)) / 2);
            margin: auto;
            background-color:#f1f1f1;
            right: 0;
            box-sizing: border-box;
            padding: 20px;
            display: flex;
            overflow: auto;
            position: relative;
        }

        .bot-container {
            position: absolute;
            width: 100%;
            height: calc(50%);
            margin: auto;
            background-color:#f1f1f1;
            right: 0;
            box-sizing: border-box;
        }

        .chart-container
        {
            width: 66%;
            height: auto;
            margin: auto;
            background-color:#f1f1f1;
            resize: both;
        }

        #sigma-container {
            width: 100%;
            height: calc( (100vh - (60px)) / 2);
            max-height: inherit;
        }

        .content-container {
            height: calc(100vh - (60px));
        }

    </style>
</head>
<body>

    <nav class="nav">
    <div class="nav-item">
        Home
    </div>
    <div class="nav-item">
        Algorithms
        <span class="caret"></span>
    </div>
</nav>



    <div class="leftContainer">

        <div class="top-container">
            <div id="showDistanceGraph" class="circle icon" >
                <i class="fas fa-sync-alt"></i>
            </div>

            <div class="chart-container" id="c1">
                <canvas id="distanceChart"></canvas>
            </div>
            <div class="chart-container" id="c2">
                <canvas id="fitnessChart"></canvas>
            </div>
        </div>

        <div class="bot-container">
            <div id="toggleEdit" class="circle icon">
                <i class="fas fa-edit" style="font-size: 0.9em;"></i>
            </div>
            <div id='sigma-container'></div>
        </div>


    </div>

    <div class="content-container">
        <div class="panel-item" style=""><h3>Setting</h3></div>
        <div class="slideContainer panel-item">
            <div class="sliderTitle disableAble">Number of Node:</div>
            <input type="range" min="5" max="25" value="15" class=" slider disableAble" id="nodeNum">
            <div id="nodeNumVal" class="sliderValue disableAble">15</div>
        </div>
        <div class="slideContainer panel-item">
            <div class="sliderTitle disableAble">Population Size:</div>
            <input type="range" min="30" max="1000" value="50" class=" slider disableAble" id="popSize">
            <div id="popSizeVal" class="sliderValue disableAble">15</div>
        </div>
        <div class="slideContainer panel-item">
            <div class="sliderTitle disableAble">Mutation Rate:</div>
            <input type="range" min="0" max="1" value="0.015" step="0.001" class=" slider disableAble" id="mutationRate">
            <div id="mutationRateVal" class="sliderValue disableAble">15</div>
        </div>
        <div class="slideContainer panel-item">
            <div class="sliderTitle disableAble">Number of Elite:</div>
            <input type="range" min="1" max="5" value="1" class=" slider disableAble" id="numElite">
            <div id="numEliteVal" class="sliderValue disableAble">15</div>
        </div>
        <div class="row d-flex justify-content-between panel-item" style="padding-left: 15px; padding-top: 15px;">
            <button id="runBtn" class="button" onclick="run()">Run</button>
            <button id="randomBtn" class="button" onclick="randomiseCities()">Randomise Cities</button>
            <button id="resetBtn" class="button" onclick="resetDefault()">Reset Default</button>
        </div>

        <br><br>

        <div class="panel-item" style=""><h3>Result</h3></div>
        <div id="gen">generation: </div>

        <div id="in" class="circle">
            <i class="fas fa-search-plus"></i>
        </div>

        <div id="out" class="circle">
            <i class="fas fa-search-plus"></i>
        </div>
    </div>






</body>
</html>
<script>

    $("#in").click(function () {
        $(".bot-container").hide();
        $(".top-container").css("height", "100%");
        // $(".top-container").css("display", "flex");
        $(".chart-container").css("width", "100%");
        // distanceChart.update();



    })

    $("#out").click(function () {
        $(".bot-container").show();
        $(".top-container").css("height", "50%");
        // $(".top-container").css("display", "normal");
    })

    let nodeSlider = document.getElementById("nodeNum");
    let nodeVal = document.getElementById("nodeNumVal");
    nodeVal.innerHTML = nodeSlider.value;

    nodeSlider.oninput = function() {
        nodeVal.innerHTML = this.value;
        randomiseCities();
    }

    let popSizeSlider = document.getElementById("popSize");
    let popSizeVal = document.getElementById("popSizeVal");
    popSizeVal.innerHTML = popSizeSlider.value;

    popSizeSlider.oninput = function() {
        popSizeVal.innerHTML = this.value;
        populationSize = parseInt(this.value);
    }

    let mutationRateSlider = document.getElementById("mutationRate");
    let mutationRateVal = document.getElementById("mutationRateVal");
    mutationRateVal.innerHTML = mutationRateSlider.value;

    mutationRateSlider.oninput = function() {
        mutationRateVal.innerHTML = this.value;
        mutationRate = this.value;
    }

    let numEliteSlider = document.getElementById("numElite");
    let numEliteVal = document.getElementById("numEliteVal");
    numEliteVal.innerHTML = numEliteSlider.value;

    numEliteSlider.oninput = function() {
        numEliteVal.innerHTML = this.value;
        eliteSize = this.value;
    }


    let showDefaultChart = true;
    $("#c2").hide();

    $("#showDistanceGraph").click(function () {

        if(showDefaultChart)
        {
            $("#c1").hide();
            $("#c2").fadeIn();
            showDefaultChart = false;
        }
        else
        {
            $("#c2").hide();
            $("#c1").fadeIn();
            showDefaultChart = true;
        }

    })



    //Initialise sigma:
    let s = new sigma(
        {
            renderer: {
                container: document.getElementById('sigma-container'),
                type: 'canvas'
            },
            settings: {
                minEdgeSize: 1,
                maxEdgeSize: 3,
                minNodeSize: 1,
                maxNodeSize: 10,
                enableCamera: false,
                defaultEdgeLabelSize: 15,
                sideMargin: 15,
            }
        }
    );

    let graph = {
        nodes: [],
        edges: []
    };

    let graphIndex = 0;
    let fittestTours = new Array();
    let worstTours = new Array();

    let ctx = document.getElementById('fitnessChart').getContext('2d');
    let fitnessCtx = {
        // The type of chart we want to create
        type: 'line',

        // The data for our dataset
        data: {
            labels: [],
            datasets: [{
                label: 'Best Fitness',
                backgroundColor: 'rgba(75, 192, 192)',
                borderColor: 'rgba(75, 192, 192)',
                data: [],
                fill: false,
                pointHoverRadius: 8,
                pointHoverBackgroundColor: 'rgba(75, 192, 192)',
                pointHoverBorderColor: 'black',
            },
                {
                    label: 'Average Fitness',
                    backgroundColor: 'rgba(255, 159, 64)',
                    borderColor: 'rgba(255, 159, 64)',
                    data: [],
                    fill: false,
                    pointHoverRadius: 8,
                    pointHoverBackgroundColor: 'rgba(255, 159, 64)',
                    pointHoverBorderColor: 'black',
                },
                {
                    label: 'Worse Fitness',
                    backgroundColor: 'rgb(255, 99, 132)',
                    borderColor: 'rgb(255, 99, 132)',
                    data: [],
                    fill: false,
                    pointHoverRadius: 8,
                    pointHoverBackgroundColor: 'rgb(255, 99, 132)',
                    pointHoverBorderColor: 'black',
                }]
        },

        // Configuration options go here
        options: {
            responsive: true,
            title: {
                display: true,
                text: 'Fitness Value vs. Generation',
                fontSize: 16,
            },
            scales: {
                xAxes: [{
                    ticks: {
                        autoSkip: true,
                        maxTicksLimit: 50,
                        min:0,
                        max:1001,
                    },
                    scaleLabel: {
                        display: true,
                        labelString: 'Generation',
                        fontStyle: 'bold',
                    }
                }],
                yAxes: [{
                    ticks: {
                        min:0,
                    },
                    scaleLabel: {
                        display: true,
                        labelString: 'Fitness Value',
                        fontStyle: 'bold',
                    }
                }]
            },
            onClick: function(evt) {


                let element = fitnessChart.getElementsAtEventForMode(evt, 'point', fitnessChart.options);

                // console.log(element.datasetIndex);

                // if click on a dot
                if(element.length!=0) {
                    let firstPoint = element[0];

                    let selectedTours = new Array();
                    if(firstPoint._datasetIndex == 0)   // best is selected
                        selectedTours = fittestTours;
                    else if(firstPoint._datasetIndex == 2)  // worst is selected
                        selectedTours = worstTours;

                    if(selectedTours.length != 0) {
                        let label = fitnessChart.data.labels[firstPoint._index];
                        let value = fitnessChart.data.datasets[firstPoint._datasetIndex].data[firstPoint._index];
                        // alert(label + ": " + value);
                        graphIndex = label;

                        convertCityToNodes(geneticTM, graph);
                        convertTourToEdges(selectedTours[graphIndex], graph);
                        updateSigma(s, graph);

                        console.log(selectedTours[graphIndex].getDistance());
                        console.log(selectedTours[graphIndex].printTour())
                    }
                }
            },
        }
    }
    let fitnessChart = new Chart(ctx, fitnessCtx);

    let ctx2 = document.getElementById('distanceChart').getContext('2d');
    let distanceCtx = {
        // The type of chart we want to create
        type: 'line',
        // The data for our dataset
        data: {
            responsive: true,
            labels: [],
            datasets: [{
                label: 'Minimum Distance',
                backgroundColor: 'rgba(75, 192, 192)',
                borderColor: 'rgba(75, 192, 192)',
                data: [],
                fill: false,
                pointHoverRadius: 8,
                pointHoverBackgroundColor: 'rgba(75, 192, 192)',
                pointHoverBorderColor: 'black',
            },
                {
                    label: 'Average Distance',
                    backgroundColor: 'rgba(255, 159, 64)',
                    borderColor: 'rgba(255, 159, 64)',
                    data: [],
                    fill: false,
                    pointHoverRadius: 8,
                    pointHoverBackgroundColor: 'rgba(255, 159, 64)',
                    pointHoverBorderColor: 'black',
                },
                {
                    label: 'Maximum Distance',
                    backgroundColor: 'rgb(255, 99, 132)',
                    borderColor: 'rgb(255, 99, 132)',
                    data: [],
                    fill: false,
                    pointHoverRadius: 8,
                    pointHoverBackgroundColor: 'rgb(255, 99, 132)',
                    pointHoverBorderColor: 'black',
                }]
        },
        // Configuration options go here
        options: {
            title: {
                display: true,
                text: 'Distance vs. Generation',
                fontSize: 16,
            },
            scales: {
                xAxes: [{
                    ticks: {
                        autoSkip: true,
                        maxTicksLimit: 50,
                        min:0,
                        max:1001,
                    },
                    scaleLabel: {
                        display: true,
                        labelString: 'Generation',
                        fontStyle: 'bold',
                    }
                }],
                yAxes: [{
                    ticks: {
                        min:0,
                    },
                    scaleLabel: {
                        display: true,
                        labelString: 'Distance',
                        fontStyle: 'bold',
                    }
                }]
            },
            onClick: function(evt) {
                let element = distanceChart.getElementsAtEventForMode(evt, 'point', distanceChart.options);
                // if click on a dot
                if(element.length!=0) {
                    let firstPoint = element[0];

                    let selectedTours = new Array();
                    if(firstPoint._datasetIndex == 0)   // best is selected
                        selectedTours = fittestTours;
                    else if(firstPoint._datasetIndex == 2)  // worst is selected
                        selectedTours = worstTours;

                    if(selectedTours.length != 0) {
                        let label = distanceChart.data.labels[firstPoint._index];
                        let value = distanceChart.data.datasets[firstPoint._datasetIndex].data[firstPoint._index];
                        // alert(label + ": " + value);
                        graphIndex = label;

                        convertCityToNodes(geneticTM, graph);
                        convertTourToEdges(selectedTours[graphIndex], graph);
                        updateSigma(s, graph);

                        console.log(selectedTours[graphIndex].getDistance());
                        console.log(selectedTours[graphIndex].printTour())
                    }
                }

            },
        }
    }
    let distanceChart = new Chart(ctx2, distanceCtx);


    // GA Program
    let geneticTM = new TourManager();
    geneticTM.clone(TM);

    let mutationRate = 0.015;
    let eliteSize = 1;
    let populationSize = 100;
    let GenNumber = 50;

    // let bestFitness = new Array();
    // let avgFitness = new Array();
    // let generations = new Array();

    // Initialize population
    let pop = new Population(populationSize, geneticTM, true);
    let ga = new GA(pop, geneticTM, mutationRate, eliteSize);
    pop = ga.evolvePopulation(pop, geneticTM);
    fittestTours.push(pop.getFittest());
    worstTours.push(pop.getWorst());

    // get initial solution
    let best = pop.getFittest();
    let current = new Tour();

    // console.log("Initial distance: " + pop.getFittest().getDistance());
    // console.log("Tour: " + pop.getFittest().printTour());

    best = new Tour(pop.getFittest().getTour());

    convertCityToNodes(geneticTM, graph);
    updateSigma(s,graph);

    // console.log(fitnessChart.data.datasets);

    // Evolve population for 100 generations
    // evolve();



    // for (let i = 0; i < 100; i++) {
    //     pop = ga.evolvePopulation(pop, geneticTM);
    // }

    // Print final results
    // console.log("Final distance: " + pop.getFittest().getDistance());
    // console.log("Tour: " + pop.getFittest().printTour());
    // console.log("best distance: " + pop.getFittest().getDistance());
    // console.log("Tour: " + best.printTour());


    async function evolve()
    {

        console.log("Initial distance: " + pop.getFittest().getDistance());
        console.log("Tour: " + pop.getFittest().printTour());


        addData(fitnessChart, 0, pop.getFittest().getFitness(),
            pop.getMeanFitness(), pop.getWorst().getFitness());
        addData(distanceChart, 0, pop.getFittest().getDistance(),
            pop.getMeanDistance(), pop.getWorst().getDistance());


        // Evolve population for 100 generations
        for (let i = 0; i < 100; i++) {
            pop = ga.evolvePopulation(pop, geneticTM);
            $("#gen").text("Generation: " + (i+1));

            pop.sort();
            console.log("gen: " + (i+1));
            console.log(pop);

            fittestTours.push(pop.getFittest());
            worstTours.push(pop.getWorst());

            convertCityToNodes(geneticTM, graph);
            convertTourToEdges(pop.getFittest(), graph);
            updateSigma(s, graph);
            graphIndex = (i+1);

            // bestFitness.push(pop.getFittest().getFitness());
            // avgFitness.push(pop.getMeanFitness());
            // generations.push((i+1));

            addData(fitnessChart, (i+1), pop.getFittest().getFitness(),
                pop.getMeanFitness(), pop.getWorst().getFitness());
            addData(distanceChart, (i+1), pop.getFittest().getDistance(),
                pop.getMeanDistance(), pop.getWorst().getDistance());

            await sleep(1);
        }
        // updateChart();


        console.log("Final distance: " + pop.getFittest().getDistance());
        console.log("Tour: " + pop.getFittest().printTour());



    }

    function run()
    {
        cleanChart(fitnessChart);
        cleanChart(distanceChart);
        pop = new Population(populationSize, geneticTM, true);
        ga = new GA(pop, geneticTM, mutationRate, eliteSize);
        evolve();
    }


    function addData(chart, label, bestData, avgData, worstData) {
        let index = parseInt(label);
        chart.data.labels[index] = label;
        chart.data.datasets[0].data[index] = bestData;
        chart.data.datasets[1].data[index] = avgData;
        chart.data.datasets[2].data[index] = worstData;
        chart.update();
    }

    function cleanChart(chart)
    {
        for(let i=0;i<3;i++)
        {
            chart.data.datasets[i].data = [];
            chart.data.labels = [];
        }
    }

    function randomiseCities()
    {

        let num = $("#nodeNum").val();
        num = parseInt(num);

        geneticTM.clear();

        let alp = 65;

        for(let i =65; i < (alp + num);i++)
        {
            geneticTM.addCity(new City(String.fromCharCode(i)));
        }
        pop = new Population(populationSize, geneticTM, true);
        ga = new GA(pop, geneticTM, mutationRate, eliteSize);

        convertCityToNodes(geneticTM, graph);
        clearArray(graph.edges);
        updateSigma(s,graph);


        resetInfo();
    }

    function resetDefault() {
        geneticTM.clear();
        geneticTM.clone(TM);
        pop = new Population(populationSize, geneticTM, true);
        ga = new GA(pop, geneticTM, mutationRate, eliteSize);
        convertCityToNodes(geneticTM, graph);
        clearArray(graph.edges);
        updateSigma(s,graph);
        resetInfo();
    }

    function resetInfo()
    {

    }


</script>